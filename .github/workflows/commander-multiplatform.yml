name: Commander Multiplatform

on:
  push:
    paths:
      - 'Commander/**'
      - '.github/workflows/commander-multiplatform.yml'
  pull_request:
    paths:
      - 'Commander/**'
      - '.github/workflows/commander-multiplatform.yml'
  workflow_dispatch:

jobs:
  macos-host:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Swift version
        working-directory: Commander
        run: swift --version
      - name: Test (macOS)
        working-directory: Commander
        run: swift test

  apple-simulators:
    runs-on: macos-latest
    needs: macos-host
    strategy:
      matrix:
        include:
          - platform: iOS
            sdk: iphonesimulator
            triple: arm64-apple-ios17.0-simulator
          - platform: tvOS
            sdk: appletvsimulator
            triple: arm64-apple-tvos17.0-simulator
          - platform: watchOS
            sdk: watchsimulator
            triple: arm64-apple-watchos10.0-simulator
          - platform: visionOS
            sdk: xrsimulator
            triple: arm64-apple-xros1.0-simulator
    defaults:
      run:
        working-directory: Commander
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build for ${{ matrix.platform }}
        run: |
          set -euo pipefail
          SDK_PATH=$(xcrun --sdk ${{ matrix.sdk }} --show-sdk-path)
          xcrun --sdk ${{ matrix.sdk }} swift build \
            --build-tests \
            --triple "${{ matrix.triple }}" \
            --sdk "$SDK_PATH"

  linux:
    runs-on: ubuntu-24.04
    needs: macos-host
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: SwiftyLab/setup-swift@v1
        with:
          swift-version: '6.2.1'
      - name: Test (Linux)
        working-directory: Commander
        run: swift test

  android:
    runs-on: ubuntu-22.04
    needs: macos-host
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Android build + test
        uses: skiptools/swift-android-action@v2
        with:
          swift-version: '6.2.1'
          swift-branch: 'release/6.2.1'
          package-path: 'Commander'
          swift-configuration: 'debug'
          android-api-level: 34
          android-emulator-options: '-no-window -noaudio -no-boot-anim'
