name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    env:
      DEVELOPER_DIR: /Applications/Xcode_16.1.app/Contents/Developer
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Checkout Tachikoma
      run: |
        git clone https://github.com/steipete/tachikoma.git Tachikoma
    
    - name: Set up Xcode
      run: |
        sudo xcode-select -s $DEVELOPER_DIR
        xcodebuild -version
        swift --version
    
    - name: Generate Version.swift
      run: |
        VERSION=$(node -p "require('./version.json').version")
        GIT_COMMIT="ci-build"
        GIT_COMMIT_DATE=$(date -Iseconds)
        GIT_BRANCH="${GITHUB_REF_NAME}"
        BUILD_DATE=$(date -Iseconds)
        
        mkdir -p Apps/CLI/Sources/peekaboo
        cat > Apps/CLI/Sources/peekaboo/Version.swift << EOF
        // This file is auto-generated by the build script. Do not edit manually.
        enum Version {
            static let current = "Peekaboo $VERSION"
            static let gitCommit = "$GIT_COMMIT"
            static let gitCommitDate = "$GIT_COMMIT_DATE"
            static let gitBranch = "$GIT_BRANCH"
            static let buildDate = "$BUILD_DATE"
            
            static var fullVersion: String {
                return "\(current) (\(gitBranch)/\(gitCommit), built: \(buildDate))"
            }
        }
        EOF
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build TypeScript and Swift CLI
      run: npm run build
    
    - name: Verify Swift CLI binary exists
      run: |
        # Verify the CLI binary was built by npm run build
        ls -la peekaboo
        ./peekaboo --version
    
    - name: Run linter
      run: npm run lint:swift --if-present
    
    - name: Run Swift tests (quick check)
      if: matrix.node-version == '20.x'
      timeout-minutes: 10
      run: |
        cd Apps/CLI
        # Run a subset of Swift tests for quick validation
        swift test --parallel --filter "ConfigCommandTests|VersionTests"
      env:
        CI: true

  build-swift:
    runs-on: macos-latest
    timeout-minutes: 30
    
    env:
      DEVELOPER_DIR: /Applications/Xcode_16.1.app/Contents/Developer
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Checkout Tachikoma
      run: |
        git clone https://github.com/steipete/tachikoma.git Tachikoma
    
    - name: Set up Xcode
      run: |
        sudo xcode-select -s $DEVELOPER_DIR
        xcodebuild -version
        swift --version
    
    - name: Generate Version.swift
      run: |
        VERSION=$(node -p "require('./version.json').version")
        GIT_COMMIT="ci-build"
        GIT_COMMIT_DATE=$(date -Iseconds)
        GIT_BRANCH="${GITHUB_REF_NAME}"
        BUILD_DATE=$(date -Iseconds)
        
        mkdir -p Apps/CLI/Sources/peekaboo
        cat > Apps/CLI/Sources/peekaboo/Version.swift << EOF
        // This file is auto-generated by the build script. Do not edit manually.
        enum Version {
            static let current = "Peekaboo $VERSION"
            static let gitCommit = "$GIT_COMMIT"
            static let gitCommitDate = "$GIT_COMMIT_DATE"
            static let gitBranch = "$GIT_BRANCH"
            static let buildDate = "$BUILD_DATE"
            
            static var fullVersion: String {
                return "\(current) (\(gitBranch)/\(gitCommit), built: \(buildDate))"
            }
        }
        EOF
    
    - name: Build Swift CLI
      run: |
        cd Apps/CLI
        swift build -c release
    
    - name: Run Swift tests
      timeout-minutes: 15
      run: |
        cd Apps/CLI
        # Run only tests that are known to compile and work
        swift test --parallel --filter "ConfigCommandTests|ListCommandTests|VersionTests|ModelsTests|FileHandlingTests|ConfigurationTests|MCPClientCommandTests|TypeCommandTests|PressCommandTests"
      env:
        CI: true

  build-mac-app:
    runs-on: macos-latest
    timeout-minutes: 30
    
    env:
      DEVELOPER_DIR: /Applications/Xcode_16.1.app/Contents/Developer
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Checkout Tachikoma
      run: |
        git clone https://github.com/steipete/tachikoma.git Tachikoma
    
    - name: Set up Xcode
      run: |
        sudo xcode-select -s $DEVELOPER_DIR
        xcodebuild -version
        swift --version
    
    - name: Build Mac App
      run: |
        xcodebuild -workspace Apps/Peekaboo.xcworkspace -scheme Peekaboo -configuration Debug build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
      env:
        CI: true