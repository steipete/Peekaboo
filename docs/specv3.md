# Software Design Document · Peekaboo 3.0

**Version:** 3.0 · **Status:** Living document · **Last updated:** 2025-11-14

Peekaboo 3.0 is the unified automation stack that powers the CLI, Peekaboo.app, the MCP server, and downstream agent integrations. This revision trims legacy command tables and instead points to the authoritative docs in `docs/commands/`. The goal is to keep this file focused on architecture, invariants, and cross-cutting behaviors that every surface depends on.

---

## 1. Vision & Scope

Peekaboo exists to make macOS automation as deterministic as modern web automation frameworks. The platform lets humans or AI agents **see**, **reason**, and **act** inside native apps with predictable timing, session-aware state, and structured logs. Shipping artifacts:

- **CLI (`peekaboo`)** — the primary product. It must stay self-contained, Homebrew-installable, and capable of running every automation end-to-end without Xcode.
- **Peekaboo.app** — macOS UI/inspector that shares the same service layer for capture, focus, and logging.
- **PeekabooCore** — Swift packages that host capture, accessibility traversal (via AXorcist), UIAutomationService, session management, and configuration/state APIs.
- **MCP server & clients** — Tachikoma-powered glue that exposes Peekaboo tools to Claude/Inspector and lets Peekaboo consume other MCP servers.
- **Agents** — `peekaboo agent` + Tachikoma orchestrations that translate natural-language tasks into concrete tool calls (default model: `gpt-5-mini`, with `gpt-5` and `claude-sonnet-4.5` as supported overrides).

Scope deliberately excludes any backwards-compatibility shim: breaking changes are acceptable when they simplify the stack or remove duplicate flows.

## 2. Core Principles

1. **CLI-first** – the CLI must be able to perform everything the rest of the system does; other surfaces are shells around the same services.
2. **Semantic interaction** – element targeting relies on AX metadata and Peekaboo element IDs, not raw coordinates (coords are supported but always optional).
3. **Visual debuggability** – annotated screenshots (`see --annotate`) and structured JSON outputs are required for every interaction so agents can reason deterministically.
4. **Reliability by default** – commands auto-focus windows (`FocusCommandOptions`), wait for actionable elements, and reuse cached sessions unless explicitly told not to.
5. **Agent awareness** – all outputs are parseable (`--json-output`), and commands expose enough metadata (bounds, IDs, timings) for autonomous decision making.

## 3. System Architecture Overview

| Layer | Responsibilities | Notable Types |
| --- | --- | --- |
| **PeekabooCore services** | Capture (`ScreenCaptureService`), automation (`UIAutomationService`), dialogs/menus/dock, session cache, configuration. | `CommandRuntime`, `SessionManager`, `FocusOptions`, `WindowServiceBridge`. |
| **CLI Commands** | Parse Commander signatures, bind runtime options, invoke services, and format output. | Located under `Apps/CLI/Sources/PeekabooCLI/Commands`. |
| **Peekaboo.app / Playground** | Provide inspector UI, log streaming, and test fixtures (e.g., Playground Hidden Fields) while sharing PeekabooCore. | `Apps/Peekaboo`, `Apps/Playground`. |
| **Agent runtime** | Wraps PeekabooCore services inside Tachikoma agents, handles multi-step planning, session caching, and streaming updates. | `PeekabooAgentService`, `AgentDisplayTokens`. |
| **MCP layer** | Hosts `PeekabooMCPServer`, manages external MCP clients via `TachikomaMCPClientManager`, and exposes CLI-equivalent tools to other LLM hosts. | `docs/commands/mcp.md`. |

## 4. Session & State Management

Peekaboo does not run a daemon; every CLI invocation stands up its own services and writes transient artifacts under `~/.peekaboo/session/<PID>/`:

- `raw.png` / `annotated.png` — generated by `SeeCommand` / `ImageCommand`.
- `map.json` — serialized accessibility tree + Peekaboo element IDs.
- Additional run metadata stored via `SessionManager` for consumption by `services.sessions`.

**Creation & resolution**
1. `peekaboo see` always captures fresh state and writes a new session directory (atomic temp dir → rename).
2. Interaction commands (`click`, `type`, `scroll`, etc.) accept `--session`, but when omitted they call `services.sessions.getMostRecentSession()` (same code path visible in `ClickCommand`, `TypeCommand`, `ScrollCommand`).
3. Commands that solely operate on geometry (`click --coords`, `move 100,100`, etc.) skip session resolution entirely.

**Focus/space handling**
- Shared `FocusCommandOptions` defaults to `autoFocus=true`, so after resolving sessions the command will call `ensureFocused` (optionally hopping or moving Spaces via `--space-switch` / `--bring-to-current-space`).
- Window commands reuse `WindowIdentificationOptions`, guaranteeing every manipulating call knows which app/window to touch before reaching `WindowServiceBridge`.

**Garbage collection**
- `peekaboo clean` (docs in `commands/clean.md`) is the sanctioned way to delete sessions. It proxies into `services.files.clean*` helpers, enforces mutually-exclusive flags (`--all-sessions`, `--older-than`, `--session`), and surfaces bytes freed.

## 5. CLI Command Documentation

Detailed usage, quirks, and examples live in `docs/commands/*.md`. Each file mirrors a top-level CLI command and is now the single source of truth for flags and behaviors. Highlights:

### Vision & capture
- [`commands/see.md`](commands/see.md)
- [`commands/image.md`](commands/image.md)

### Core utilities
- [`commands/list.md`](commands/list.md)
- [`commands/tools.md`](commands/tools.md)
- [`commands/config.md`](commands/config.md)
- [`commands/permissions.md`](commands/permissions.md)
- [`commands/learn.md`](commands/learn.md)
- [`commands/run.md`](commands/run.md), [`commands/sleep.md`](commands/sleep.md), [`commands/clean.md`](commands/clean.md)

### Interaction
- Pointer/keyboard: [`commands/click.md`](commands/click.md), [`commands/type.md`](commands/type.md), [`commands/press.md`](commands/press.md), [`commands/hotkey.md`](commands/hotkey.md)
- Motion: [`commands/scroll.md`](commands/scroll.md), [`commands/swipe.md`](commands/swipe.md), [`commands/drag.md`](commands/drag.md), [`commands/move.md`](commands/move.md)

### Window & system mgmt
- [`commands/window.md`](commands/window.md), [`commands/menu.md`](commands/menu.md), [`commands/menubar.md`](commands/menubar.md)
- [`commands/app.md`](commands/app.md), [`commands/open.md`](commands/open.md), [`commands/dock.md`](commands/dock.md)
- [`commands/dialog.md`](commands/dialog.md), [`commands/space.md`](commands/space.md)

### Agents & integrations
- [`commands/agent.md`](commands/agent.md)
- [`commands/mcp.md`](commands/mcp.md)

Whenever you touch a command, update its corresponding doc and keep `docs/cli-command-reference.md` as the lightweight index. The spec intentionally omits per-flag detail to avoid drift.

## 6. Agent & MCP Surfaces

- **Agent runtime** (`peekaboo agent`): Streams progress using GPT-5/Claude via Tachikoma. Supports dry-run planning, max-step caps, session resume, and audio (`--audio`, `--audio-file`, `--realtime`). Output modes adapt to the terminal capabilities (see `TerminalDetector`). Full behavior: `docs/commands/agent.md`.
- **MCP server** (`peekaboo mcp serve`): Spins up `PeekabooMCPServer` over stdio/HTTP/SSE and exposes the same tools listed above. Client management commands (`add`, `list`, `test`, `call`, etc.) update the persistent profile used by Claude Code and MCP Inspector integrations. Details: `docs/commands/mcp.md`.

## 7. Implementation Notes & Future Work

- **Approachable concurrency**: CLI/app targets run under `.defaultIsolation(MainActor.self)` (see `docs/concurrency.md`). Background helpers should stay `nonisolated` unless they directly touch AppKit.
- **Default tooling expectations**: Always launch binaries through `polter peekaboo …` to guarantee a fresh build and ensure the macOS app companion is launched alongside the CLI when needed.
- **Testing**: Long-running suites (e.g., `swift test --filter TypeCommandTests`) still require `RUN_LOCAL_TESTS=true`; smaller targeted suites should be wired into CI progressively as compiler issues are resolved.

This trimmed spec should stay evergreen: architecture + invariants live here, while anything command-specific belongs in `docs/commands`. Update both when behavior changes.
